name: schedule_dbt_job

on:
   push:
    branches:
       - QA
       
env:
   DBT_PROFILES_DIR: ./
   DBT_SNOWFLAKE_ACCOUNT: ${{ secrets.SF_ACCOUNT }}
   DBT_SNOWFLAKE_USERNAME: ${{ secrets.SF_QA_USERNAME }}
   DBT_SNOWFLAKE_PW: ${{ secrets.SF_QA_PASSWORD }}
   
jobs:
   dbt_deploy_job:
    name: dbt_qa_deploy_job
    runs-on: ubuntu-latest

    steps:
       - name: Check out
         uses: actions/checkout@master

       - uses: actions/setup-python@v1
         with:
           python-version: "3.9.x"

       - name: Install dependencies
         run: |
           pip install dbt-snowflake
           dbt deps

       # dbt related commands here - run use --target prod/qa/dev to run for specific environments
       - name: Run dbt compile
         run: dbt compile
         
       - name: Upload compiled artifacts
         uses: actions/upload-artifact@v3
         with:
          name: dbt-compiled-artifacts
          path: target/manifest.json
          
       - name: Download artifacts
         uses: actions/download-artifact@v3
         with:
           name: dbt-compiled-artifacts
           path: ./target
       - name: Move artifacts to repository
         run: |
            mkdir -p ./target
            mv -Force ./target/* ./target/
       - name: Commit and push changes
         env:
           GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
         run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git add .
          git commit -m "Add dbt compiled artifacts"
          git push origin QA
       - name: Run dbt models
         run: dbt run --target QA --models state:modified --state .
            
