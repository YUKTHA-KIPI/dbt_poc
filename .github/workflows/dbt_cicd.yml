name: schedule_dbt_job

on:
   push:
    branches:
       - QA
       
env:
   DBT_PROFILES_DIR: ./
   DBT_SNOWFLAKE_ACCOUNT: ${{ secrets.SF_ACCOUNT }}
   DBT_SNOWFLAKE_USERNAME: ${{ secrets.SF_QA_USERNAME }}
   DBT_SNOWFLAKE_PW: ${{ secrets.SF_QA_PASSWORD }}
   
jobs:
   dbt_deploy_job:
    name: dbt_qa_deploy_job
    runs-on: ubuntu-latest

    steps:
       - name: Check out
         uses: actions/checkout@master

       - uses: actions/setup-python@v1
         with:
           python-version: "3.9.x"
           
       - name: Load environment variables
         run: |
          echo "Loading environment variables from config.env"
          set -a
          source config.env
          set +a
          # Exporting the variables to the GitHub Actions environment
          for var in $(cat config.env | grep -v '^#' | sed 's/=.*//'); do
            echo "$var=${!var}" >> $GITHUB_ENV
          done

       - name: Use the variable
         run: echo "TABLE NAME - $TABLE_NAME"
       - name: Install dependencies
         run: |
           pip install dbt-snowflake
           dbt deps
       - name: Run DBT Macro to Drop Tables
         run: |
          dbt run-operation drop_tables --args '{"tables": "$TABLE_NAME"}'
 
       - name: dbt run
         run: |
                
                dbt run --target QA
     

